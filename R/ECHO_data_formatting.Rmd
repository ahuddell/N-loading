---
title: "format ECHO data"
author: "Alex Huddell"
date: "7/28/2021"
output:
  word_document: default
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries and data

```{r }
library(tidyverse)
library(lubridate)
library(here)

col_specifications<-('ccffffffffffddff') #compact string to specify column types

dat<-read_csv(file=here("data","Echo_LIS_complete_data.csv"), 
                     col_types = col_specifications)

dat<-distinct(dat) #remove a few duplicate rows

```
#Data exploration visualization
```{r}
#analyzing distributions of Parameter codes
levels(dat$Parameter)

levels<-dat %>%
  group_by(Parameter) %>%
  tally()

ggplot(levels, aes(Parameter,n))+
  geom_col() +
  ylab("count of observations")+
  theme(axis.text.x=element_text(angle = 60, hjust=1))
  
#analyzing distributions of stats codes
levels2<-dat %>%
  group_by(`Statistical Base Long Desc`) %>%
  tally()

levels2 %>% filter(n>1) %>%  ggplot(aes(`Statistical Base Long Desc`,n))+
  geom_col() +
  ylab("count of observations")+
  theme(axis.text.x=element_text(angle = 60, hjust=1))

#looking at distribution of designators
levels(dat$Designator)

levels<-dat %>%
  group_by(Designator) %>%
  tally()

ggplot(levels, aes(Designator,n))+
  geom_col() +
  ylab("count of observations")


#looking at distribution of monitoring locations
levels(dat$`Monitoring Location`)

levels<-dat %>%
  group_by(`Monitoring Location`) %>%
  tally()

ggplot(levels, aes(`Monitoring Location`,n))+
  geom_col() +
  ylab("count of observations")


```


#Standardize data

```{r pressure, echo=FALSE}
#impute zeros for  "No Discharge Code - C" 
dat$`Reported Value` <-
  ifelse(dat$`Reported Value` == "No Discharge Code - C" ,
         0,
         dat$`Reported Value`)#reformating several columns
dim(dat)
names(dat)

#renaming columns and 
dat<-dat%>%
  rename(date=`Monitoring Period`,
        value=`Reported Value`,
         facility=`Facility Name`,
         permit=`Permit ID`) %>%

# reformatting date and add a key and number of days in month column, then filter out some problematic units
  mutate(date=mdy(date)) %>%
  mutate(key = paste0(permit, "_", Outfall, "_", date)) %>%
  mutate(days_per_month = days_in_month(date))  %>%
  mutate(permit_outfall = as.factor(paste0(permit, "_", Outfall))) %>%
  mutate(permit_outfall_designator=as.factor(paste0(permit,"_",Outfall,"_",Designator)))


length(unique(as.character(dat$permit_outfall))) #1270 permit/outfalls
length(levels(as.factor(dat$key))) #159828 keys

```

```{r filter functions}
#check dimensions and levels of permit outfalls
dat<-dat%>%
  #filtering to only gross effluent monitoring locations
   filter(`Monitoring Location` %in% c("1", "2", "EA", "EG", "Y" )) %>% #this drops 153,813 rows and 95 permit/outfalls
  #removing infrequently used statistical base codes
  filter(`Statistical Base Long Desc` %in% c("Monthly Avg.", "Average Value","Daily Average", "30 Day Arithmetic Mean")) %>% #by this line, there are  466,114 rows dropped and 535 permit/outfalls dropped
  filter(!Parameter=="50047 - Flow, maximum during 24 hr period") #by this line, there are 466,826 rows dropped and 538 permit/outfalls dropped
  #filter(!Parameter=="00625 - Nitrogen, Kjeldahl, total (as N)") %>%

# #remove problematic data by hand
# dat<-dat %>% filter(!permit_outfall_designator %in% c('CT0003824_001_A',
#                                                       'CT0003824_001_B',
#                                                       'CT0003824_001_C',
#                                                       'CT0003824_001_E')) 
# #remove designators other than D for this permit
#  

dat$Parameter <- droplevels(dat)$Parameter # dropping unused levels 
dat$Units <- droplevels(dat)$Units # dropping unused levels 
dat$`Statistical Base Long Desc` <- droplevels(dat)$`Statistical Base Long Desc` #dropping unused levels 
dat$Designator <- droplevels(dat)$Designator # dropping unused levels 

```

In the next chunk, we reduce the number of units to three--one for flow, one for 
concentration, and another for loading rate. 

```{r}
#standardize units to kg per month, million L per month, or milligram per liter
dat <- dat %>% mutate(
  kg_per_month =
    case_when(
      Units == "(26) - Pounds per Day" ~ value / 2.205 * days_per_month,
      Units == "(01) - Kilograms per Day" ~ value * days_per_month, # converts per day to per month
      Units == "(35) - Grams per Day" ~ value / 1000 * days_per_month, # converts g to kg and per day to per month
      Units == "(2R) - Pounds per Hour" ~ value / 2.205 * 24 * days_per_month, # converts pounds to kg and hours to months
      Units == "(9T) - Million Pounds per Day" ~ value * 10^6 / 2.205 * days_per_month, # converts millions of pounds to kg per month
    )
)

#standardize units to millions of L per month
dat <- dat %>% mutate(
  million_L_per_month =
    case_when(
      Units == "(07) - Gallons per Day" ~ value / 10 ^ 6 * 3.785 * days_per_month,
      #converts from Gallons per day to millions L per month
      Units == "(08) - Cubic Feet per Second" ~ value * 28.317 / 10 ^ 6 * 60 * 60 * 24 * days_per_month,
      # converts cubic feet per second to million L per month
      Units == "(80) - Million Gallons per Month" ~ value * 3.785,
      # converts gallons to L
      Units == "(1X) - Gallons per Hour" ~ value / 10 ^ 6 * 3.785 * 24 * days_per_month,
      # converts gallons per hour to millions of L per month
      Units == "(8D) - Gallons per Month" ~ value / 10 ^ 6 * 3.785,
      # converts gallons to millions of L
      Units == "(03) - Million Gallons per Day" ~ value * 3.785 * days_per_month,
      # converts gallons to L and day to month
      Units == "(78) - Gallons per Minute" ~ value / 10 ^ 6 * 3.785 * 60 * 24 * days_per_month,
      # converts gallons to millions of L and minute to month
    )
)

#converting all N parameters to mass terms of nitrogen and not others (i.e. ammonia, nitrite, etc.)


dat$value <-  ifelse(
  dat$Parameter == "00608 - Nitrogen, ammonia dissolved",
  dat$value * 14.0067 / 17.031,
  dat$value
)

dat$value <- ifelse(
  dat$Parameter == "34726 - Nitrogen, ammonia, total (as NH3)",
  dat$value * 14.0067 / 17.031,
  dat$value
)



#standardize concentrations to milligrams N per liter  
dat <- dat %>% mutate(
  mg_N_per_L=
    case_when(
   Units == "(19) - Milligrams per Liter" ~ value,
   Units == "(28) - Micrograms per Liter" ~ value / 1000, #convert from micrograms to milligram
    )
  )


```
Next, we reduce the number of nitrogen to the following: total nitrogen "TN",
organic nitrogen "ON", ammonia "NH3", nitrite "NO2", nitrate "NO3", and inorganic N "IN".
We reduce the flow parameters to the following: flow rate 'flow_rate", 
maximum flow rate "flow_max_24h", total flow "flow_total", and dry flow "flow_dry".

```{r}
#cleaning up duplicate nitrogen and flow parameters 
dat$param_simple <- recode(dat$Parameter,
    #Nitrogen parameters
    "00600 - Nitrogen, total (as N)" = "TN",
    "00605 - Nitrogen, organic total (as N)" = "ON",
    "00610 - Nitrogen, ammonia total (as N)" = "NH3",
    "00615 - Nitrogen, nitrite total (as N)" = "NO2",
    "00620 - Nitrogen, nitrate total (as N)" = "NO3",
    "00625 - Nitrogen, Kjeldahl, total (as N)"= "TKN",
    "51445 - Nitrogen, Total" = "TN",
    "00608 - Nitrogen, ammonia dissolved" = "NH3",
    "00630 - Nitrite + Nitrate total (as N)" = "IN",
    "00609 - Ammonia nitrogen, total, (as N) 30 day" = "NH3",
    "49579 - Nitrogen, total Kjeldahl" = "TKN",
    "51447 - Nitrogen, Nitrite  Total" = "NO2",
    "51448 - Nitrogen, Nitrate  Total" = "NO3",
    "51449 - Nitrogen, Kjeldahl  Total" = "TKN",
    "51446 - Nitrogen, Ammonia  Total" = "NH3",
    "51087 - Nitrogen, Kjeldahl, total (TKN) (water)" = "TKN",
    "51489 - Nitrogen, Total as NO3 + NH3" = "IN",
    "34726 - Nitrogen, ammonia, total (as NH3)" = "NH3",
    "51085 - Nitrogen, ammonia (NH3-N)" = "NH3",
    "51425 - Nitrogen, Total As N" = "TN",
    "51450 - Nitrite Plus Nitrate Total" = "IN", 
    #flow parameters
    "00056 - Flow rate" = "flow_rate",
    "74076 - Flow" = "flow_rate",
    "00058 - Flow rate" = "flow_rate",
    "82220 - Flow, total" = "flow_total",
    "50050 - Flow, in conduit or thru treatment plant" ="flow_rate",
    "51061 - Flow (dry weather)" = "flow_total"
  )

#analyzing distribution of parameters
levels(dat$param_simple)

levels<-dat %>%
  group_by(param_simple) %>%
  tally()

ggplot(levels, aes(param_simple,n))+
  geom_col() +
  ylab("count of observations")


levels(dat$Parameter)

levels<-dat %>%
  group_by(Parameter) %>%
  tally()

ggplot(levels, aes(Parameter,n))+
  geom_col() +
  ylab("count of observations")+
  theme(axis.text.x=element_text(angle = 60, hjust=1))


```

#Standardizing statistics codes
For now,I excluded ALL but four statistical base codes because the others relate to maxima or other irrelevant data.
In the future, we may want to add back in some of the other statistics.

```{r}

dat$stat <- recode(dat$`Statistical Base Long Desc`,
    "Monthly Avg." = "mean",
    "Average Value" = "mean",
    "Daily Average" = "mean", 
    "30 Day Arithmetic Mean" = "mean")

dat$stat <- droplevels(dat)$stat # dropping unused levels from dat$stat

levels(dat$stat)



```

Tallying up duplicate values that complicate reshaping the data from long to wide formatting. 

```{r, echo=T}
#look at how many rows there are for each key
n_row<-dat %>%
  group_by(key)%>%
  tally() %>%
  arrange(desc(n))

hist(n_row$n) #most observations have 1-2 rows only, but a few have up to 14 rows

```
First, we'll separate the keys for which kg N/month loads already exist from those which don't, check for duplicates, then pivot data from long to wide format.

```{r}
#subset of data that report loads
N_load<- dat %>%
  group_by(key) %>%
  filter(!is.na(kg_per_month)) %>%
    #removing unwanted columns
  select(
    !c(value,
       Parameter,
      `Received Date`,
      `Monitoring Location`,
      Units,
      `Statistical Base Long Desc`,
      Column,
      days_per_month,
      Designator,
      `Seasonal Indicator`,
      Limit,
      `DMR Frequency of Analysis Code1`,
      `Limit Sample Type`)
  ) %>%
  distinct() #removing any duplicate rows


#check if there are duplicates per key and one parameter
dup<-N_load %>%
  group_by(key)%>%
  filter(param_simple=="TN") %>%
  tally() %>%
  arrange(desc(n))
#there are a few duplicates that seem like legitimate duplicates 
#(i.e. monitoring 1 vs. Y), so we can take the mean between them

#pivoting the TN and NH3 observations into wide format and removing flow and concentration columns
N_load_a<-N_load %>%
   pivot_wider(names_from = param_simple,
              values_from = kg_per_month,
              values_fn = mean) %>%
  select(-million_L_per_month,- mg_N_per_L,-stat ) %>%
  rename(kg_N_TN_per_month=TN,
         kg_N_NH3_per_month=NH3)

length(unique(as.character(N_load_a$permit_outfall))) #93 outfalls included here


```

Here we assess and then resolve duplicates by selecting only 1 flow parameter for each outfall and date, pivot the data wider calculate loads based on the concentrations and flow data, and remove the concentration and flow columns after we use them.


```{r}
#function to id columns with all NAs
not_all_na <- function(x) any(!is.na(x))


#review duplicates
keys_with_N<-dat %>%
  group_by(key) %>%
  filter(!any(!is.na(kg_per_month))) %>%
  filter(any(Parameter %in% c(
      "00600 - Nitrogen, total (as N)",
      "00605 - Nitrogen, organic total (as N)",
      "00610 - Nitrogen, ammonia total (as N)",
      "00615 - Nitrogen, nitrite total (as N)",
      "00620 - Nitrogen, nitrate total (as N)",
      "51445 - Nitrogen, Total",
      "00608 - Nitrogen, ammonia dissolved",
      "00630 - Nitrite + Nitrate total (as N)",
      "00609 - Ammonia nitrogen, total, (as N) 30 day",
      "49579 - Nitrogen, total Kjeldahl",
      "51447 - Nitrogen, Nitrite  Total",
      "51448 - Nitrogen, Nitrate  Total" ,
      "51449 - Nitrogen, Kjeldahl  Total" ,
      "51446 - Nitrogen, Ammonia  Total",
      "51087 - Nitrogen, Kjeldahl, total (TKN) (water)",
      "51489 - Nitrogen, Total as NO3 + NH3" ,
      "34726 - Nitrogen, ammonia, total (as NH3)",
      "51085 - Nitrogen, ammonia (NH3-N)",
      "51425 - Nitrogen, Total As N",
      "51450 - Nitrite Plus Nitrate Total"
    ))
  ) 
  
dup<-keys_with_N %>% 
  filter(param_simple == 'flow_rate') %>%
  group_by(key, param_simple)%>%
  drop_na('value')%>%
  tally() %>%
  filter(n>1)%>%
  arrange(desc(n))


dup<-dat %>%
  filter(is.na(kg_per_month)) %>%
  filter(!param_simple == 'flow_rate') %>%
  group_by(key, param_simple)%>%
  drop_na('value')%>%
  tally() %>%
  filter(n>1)%>%
  arrange(desc(n))
#I reviewed all of the outfalls with non-flow rate duplicates and feel comfortable averaging across them since they are close in value and seem like true duplicates

#many parameters have duplicates that we need to resolve before pivoting
# here we separate different flow parameters to remove duplicates observations

flow_56 <- dat %>%
  filter(is.na(kg_per_month)) %>%
  group_by(key) %>%
  filter(any(Parameter == '00056 - Flow rate')) %>% #this filters a group of rows at the grouped (key) level, and selects first this most common parameter
  filter(Parameter == '00056 - Flow rate')

#next, this filters the groups of rows at the grouped (key) level that do not include the 00056 parameter, and selects the second most common parameter 74076
flow_76 <- dat %>%
  filter(is.na(kg_per_month)) %>%
  group_by(key) %>%
  filter(!any(Parameter == '00056 - Flow rate')) %>%
  filter(Parameter == '74076 - Flow')

#next, this filters the groups of rows at the grouped (key) level that do not include the 00056 or 74076 parameter, and selects the least common parameter 00058
flow_58 <- dat %>%
  filter(is.na(kg_per_month)) %>%
  group_by(key) %>%
  filter(!any(Parameter == '00056 - Flow rate')) %>%
  filter(!any(Parameter == '74076 - Flow')) %>%
  filter(Parameter == '00058 - Flow rate')

#finally, we collect all nitrogen related parameters to bind to the flow observations
N_params<- dat %>%
  filter(is.na(kg_per_month)) %>%
  filter(!Parameter == '00056 - Flow rate') %>%
  filter(!Parameter == '74076 - Flow') %>%
  filter(!Parameter == '00058 - Flow rate') %>%
  distinct() 

#bind all observations back together
flow_cleaned<-rbind(flow_56,flow_76,flow_58,N_params) 

#review duplicates
dups2<-flow_cleaned %>%
  filter(is.na(kg_per_month)) %>%
  group_by(key, param_simple)%>%
  tally() %>%
  arrange(desc(n))


#subset of data that DO NOT report loads, then
#pivot wider and then remove columns with only NAs (since some parameter/unit combinations that don't make sense)
flow_N_concentration <- flow_cleaned %>%
  group_by(key) %>%
  filter(is.na(kg_per_month)) %>%
   #removing unwanted columns
  select(
    !c(value,
       Parameter,
      `Received Date`,
      `Monitoring Location`,
      Units,
      `Statistical Base Long Desc`,
      Column,
      days_per_month,
      Designator,
      `Seasonal Indicator`,
      Limit,
      `DMR Frequency of Analysis Code1`,
      `Limit Sample Type`)
  ) %>%
   pivot_wider(names_from = param_simple,
              values_from = c(mg_N_per_L, million_L_per_month),
              values_fn = mean) %>%
  select_if(not_all_na) 

###########investigating missingness in data that drops so many outfalls after this step
# #calculating N loads
# N_load_b_wide <- flow_N_concentration %>%
#   mutate(kg_N_TN_per_month = mg_N_per_L_TN * million_L_per_month_flow_rate) %>%
#   mutate(kg_N_ON_per_month = mg_N_per_L_ON * million_L_per_month_flow_rate) %>%
#   mutate(kg_N_NH3_per_month = mg_N_per_L_NH3 * million_L_per_month_flow_rate) %>%
#   mutate(kg_N_NO2_per_month = mg_N_per_L_NO2 * million_L_per_month_flow_rate) %>%
#   mutate(kg_N_NO3_per_month = mg_N_per_L_NO3 * million_L_per_month_flow_rate) 
# 
# #combine N columns in N_load_b to standardize and join dataframes
# names(N_load_b_wide)
# length(unique(as.character(N_load_b_wide$permit_outfall))) #730 outfalls included here
# 
# # #trying to understand source of missingness
# # N_load_b_wide  %>%
# #   summarise_all(list(~is.na(.)))%>%
# #   select(-'key') %>%
# #   pivot_longer(everything(),
# #                names_to = "variables", values_to="missing") %>%
# #   count(variables, missing) %>%
# #   ggplot(aes(y=variables,x=n,fill=missing))+
# #   geom_col(position = "fill")+
# #   labs(x="Proportion")+
# #   scale_fill_manual(values=c("lightgreen","lightred"))+
# #   theme(axis.title.y=element_blank())



############

#calculating N loads
N_load_b <- flow_N_concentration %>%
  mutate(kg_N_TN_per_month = mg_N_per_L_TN * million_L_per_month_flow_rate) %>%
  mutate(kg_N_ON_per_month = mg_N_per_L_ON * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NH3_per_month = mg_N_per_L_NH3 * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NO2_per_month = mg_N_per_L_NO2 * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NO3_per_month = mg_N_per_L_NO3 * million_L_per_month_flow_rate) %>%
  select(
    -mg_N_per_L_TN,
    -mg_N_per_L_ON,
    -mg_N_per_L_NH3,
    -mg_N_per_L_NO2,
    -mg_N_per_L_NO3,
    -million_L_per_month_flow_rate,
    -stat
  )

N_load_b$kg_N_inorganic_per_month <- N_load_b$kg_N_NH3_per_month +
  N_load_b$kg_N_NO3_per_month +
  N_load_b$kg_N_NO2_per_month

#adding organic N and inorganic N together as "composite" N
N_load_b$kg_N_sum_per_month <- N_load_b$kg_N_ON_per_month +
  N_load_b$kg_N_inorganic_per_month

#remove intermediate columns we no longer need
N_load_b <- N_load_b %>%
  select(
    -kg_N_NH3_per_month,-kg_N_NO3_per_month,
    -kg_N_NO2_per_month,
    -kg_N_inorganic_per_month,
    -kg_N_ON_per_month
  )

#combine the different N columns; use total N when reported, or the sum of all other
#forms of N if TN is not reported
N_load_b$kg_N_TN_per_month <-
  ifelse(
    !is.na(N_load_b$kg_N_TN_per_month),
    N_load_b$kg_N_TN_per_month,
    N_load_b$kg_N_sum_per_month
  )

#remove N sum column
N_load_b<- N_load_b %>%
  select(-kg_N_sum_per_month)

names(N_load_b)
length(unique(as.character(N_load_b$permit_outfall))) #730 outfalls included here
length(is.na(N_load_b$kg_N_TN_per_month)) #but there are 42,951 NA values
#how many outfalls without NAs for TN?
N_load_b_noNA<-N_load_b %>% filter(!is.na(kg_N_TN_per_month))
length(unique(as.character(N_load_b_noNA$permit_outfall))) #94 outfalls included here


#for N_load_a
#combine the different N columns; use total N when reported, or the sum of all other
#forms of N if TN is not reported

N_load_a$kg_N_TN_per_month <-
  ifelse(
    !is.na(N_load_a$kg_N_TN_per_month),
    N_load_a$kg_N_TN_per_month,
    N_load_a$kg_N_NH3_per_month
  )

#remove NH3 column
N_load_a<- N_load_a %>%
  select(-kg_N_NH3_per_month)

names(N_load_a)

#combine dataframes
N_load<-rbind(N_load_a,N_load_b)

length(unique(as.character(N_load$permit_outfall))) #732 outfalls with/without locations
nrow(N_load) #112,054

# write.csv(N_load,
#           file = here("data", "ECHO_data_clean_all.csv"),
#           row.names = F)


```
Loading in NPDES database with NPDES ID to match locations and other data.

```{r}
outfall_locations <-
  read_csv(file = here("data", "NPDES_PERM_FEATURE_COORDS.csv"))

names(outfall_locations)

names(N_load)

unique(as.character(N_load$permit_outfall))


#need to remove leading zeroes from outfall column
N_load$Outfall <- sub("^0+", "", N_load$Outfall)
N_load$Outfall

#create key variables with permit and locations for join
N_load$permit_outfall <- paste0(N_load$permit, "_", N_load$Outfall)
outfall_locations$permit_outfall <-
  paste0(outfall_locations$EXTERNAL_PERMIT_NMBR,
         "_",
         outfall_locations$PERM_FEATURE_NMBR)


#join locations based on permit number and outfall number
dim(N_load) #112,054, 15
length(unique(N_load$permit_outfall)) #732 outfalls with/without locations
length(unique(N_load$key)) #101,766 keys
dim(outfall_locations) # 434725      6

N_load_out <- left_join(N_load, outfall_locations, by = "permit_outfall")
dim(N_load_out) #129675, 20

length(unique(as.character(N_load_out$permit_outfall))) #732 outfalls with locations
length(unique(as.character(N_load_out$key))) #101,766 keys

```

Now join the HUC8 IDs to the data.

```{r}
HUC8_outfall_locations <-
  read_csv(file = here('data', 'HUC8_NPDES_outfall_intersection.csv'))

#select columns
HUC8_outfall_locations <- HUC8_outfall_locations %>%
  select('EXTERNAL_PERMIT_NMBR',
         'PERM_FEATURE_NMBR',
         'huc8',
         'name')

names(HUC8_outfall_locations)

#need to remove leading zeroes from outfall column
HUC8_outfall_locations$PERM_FEATURE_NMBR <- sub("^0+", "", HUC8_outfall_locations$PERM_FEATURE_NMBR)
HUC8_outfall_locations$PERM_FEATURE_NMBR


#create key variables with permit and locations for join
HUC8_outfall_locations$permit_outfall <-
  paste0(HUC8_outfall_locations$EXTERNAL_PERMIT_NMBR,
         "_",
         HUC8_outfall_locations$PERM_FEATURE_NMBR)

#join locations based on permit number and outfall number
dat_join<- left_join(N_load_out, HUC8_outfall_locations, by = "permit_outfall")

dim(N_load_out) #53,599
dim(dat_join) #53,599
length(unique(as.character(dat_join$permit_outfall))) #732 outfalls with locations
length(unique(as.character(dat_join$key))) #101,766 keys


write.csv(dat_join,
          file = here("data", "ECHO_data_clean.csv"),
          row.names = F)


```

Below are some explorations of missingness in the data. 

```{r}
# col_specifications<-('ccffffffffffddff') #compact string to specify column types
# dat2<-read_csv(file=here("data","Echo_LIS_complete_data.csv"),
#                col_types = col_specifications)
# 
# 
# dat3 <- dat2 %>%
#   distinct() %>% #remove a few duplicate rows
#   mutate(date = mdy(`Monitoring Period`)) %>%
#   mutate(key = paste0(`Permit ID`, "_", Outfall, "_", date)) %>%
#   filter(`Monitoring Location` %in% c("1", "2", "EA", "EG", "Y" ))  %>%
#   filter(`Statistical Base Long Desc` %in% c("Monthly Avg.", "Average Value","Daily Average", "30 Day Arithmetic Mean")) %>% 
#   filter(!Parameter=="50047 - Flow, maximum during 24 hr period")
# 
# unique(dat3$Parameter)
# 
# missing_N <- dat3 %>%
#   group_by(key) %>%
#   filter(all(
#     Parameter %in% c(
#       '00056 - Flow rate',
#       '74076 - Flow',
#       '00058 - Flow rate',
#       '82220 - Flow, total' ,
#       '50050 - Flow, in conduit or thru treatment plant' ,
#       '51061 - Flow (dry weather)'
#     )
#   ))
# 
# #~85k/218k observations are missing flow rate
# write.csv(missing_N, 'missing_N.csv', row.names = F)
# 
# missing_flow <- dat3 %>%
#   group_by(key) %>%
#   filter(all(Parameter %in% c(
#       "00600 - Nitrogen, total (as N)",
#       "00605 - Nitrogen, organic total (as N)",
#       "00610 - Nitrogen, ammonia total (as N)",
#       "00615 - Nitrogen, nitrite total (as N)",
#       "00620 - Nitrogen, nitrate total (as N)",
#       "51445 - Nitrogen, Total",
#       "00608 - Nitrogen, ammonia dissolved",
#       "00630 - Nitrite + Nitrate total (as N)",
#       "00609 - Ammonia nitrogen, total, (as N) 30 day",
#       "49579 - Nitrogen, total Kjeldahl",
#       "51447 - Nitrogen, Nitrite  Total",
#       "51448 - Nitrogen, Nitrate  Total" ,
#       "51449 - Nitrogen, Kjeldahl  Total" ,
#       "51446 - Nitrogen, Ammonia  Total",
#       "51087 - Nitrogen, Kjeldahl, total (TKN) (water)",
#       "51489 - Nitrogen, Total as NO3 + NH3" ,
#       "34726 - Nitrogen, ammonia, total (as NH3)",
#       "51085 - Nitrogen, ammonia (NH3-N)",
#       "51425 - Nitrogen, Total As N",
#       "51450 - Nitrite Plus Nitrate Total"
#     )
#   ))
# 
# #~3k/70k observations are missing flow
# write.csv(missing_flow, 'missing_flow.csv', row.names = F)
# 
# 
# #how many N observations are only reported in Daily Max?
# dat4 <- dat2 %>%
#   distinct() %>% #remove a few duplicate rows
#   mutate(date = mdy(`Monitoring Period`)) %>%
#   mutate(key = paste0(`Permit ID`, "_", Outfall, "_", date)) %>%
#  filter(`Monitoring Location` %in% c("1", "2", "EA", "EG", "Y" )) %>% #this drops 153,813 rows and 95 permit/outfalls
#     filter(!any(`Statistical Base Long Desc` %in% c("Monthly Avg.", "Average Value","Daily Average", "30 Day Arithmetic Mean")))  
# filter( Parameter %in% c(
#       "00600 - Nitrogen, total (as N)",
#       "00605 - Nitrogen, organic total (as N)",
#       "00610 - Nitrogen, ammonia total (as N)",
#       "00615 - Nitrogen, nitrite total (as N)",
#       "00620 - Nitrogen, nitrate total (as N)",
#       "51445 - Nitrogen, Total",
#       "00608 - Nitrogen, ammonia dissolved",
#       "00630 - Nitrite + Nitrate total (as N)",
#       "00609 - Ammonia nitrogen, total, (as N) 30 day",
#       "49579 - Nitrogen, total Kjeldahl",
#       "51447 - Nitrogen, Nitrite  Total",
#       "51448 - Nitrogen, Nitrate  Total" ,
#       "51449 - Nitrogen, Kjeldahl  Total" ,
#       "51446 - Nitrogen, Ammonia  Total",
#       "51087 - Nitrogen, Kjeldahl, total (TKN) (water)",
#       "51489 - Nitrogen, Total as NO3 + NH3" ,
#       "34726 - Nitrogen, ammonia, total (as NH3)",
#       "51085 - Nitrogen, ammonia (NH3-N)",
#       "51425 - Nitrogen, Total As N",
#       "51450 - Nitrite Plus Nitrate Total"))%>%
# 
#  
# 
# #show examples of  duplicate flows per key
# dup_flow3_keys <- dat2 %>%
#    filter(!`Statistical Base Long Desc` == 'Daily Max.') %>%
#   distinct() %>% #remove a few duplicate rows
#   mutate(date = mdy(`Monitoring Period`)) %>%
#   mutate(key = paste0(`Permit ID`, "_", Outfall, "_", date)) %>%
#   filter(`Monitoring Location` %in% c("1", "2", "EA", "EG", "Y" )) %>% #this drops 153,813 rows and 95 permit/outfalls
#  filter(Parameter %in% c('00056 - Flow rate', '74076 - Flow', '00058 - Flow rate','82220 - Flow, total' ,
#     '50050 - Flow, in conduit or thru treatment plant' ,
#     '51061 - Flow (dry weather)' )) %>%
#    group_by(key, Parameter) %>%
#     tally() %>%
#     arrange(desc(n)) %>%
#     filter(n>1)
# 
# dup_keys<-dup_flow3_keys$key
# 
# dup_flow3<- dat2 %>%
#    distinct() %>% #remove a few duplicate rows
#   mutate(date = mdy(`Monitoring Period`)) %>%
#   mutate(key = paste0(`Permit ID`, "_", Outfall, "_", date)) %>%
#   filter(key %in% dup_keys)    %>%
#    filter(!`Statistical Base Long Desc` == 'Daily Max.') %>%
#   
#   filter(`Monitoring Location` %in% c("1", "2", "EA", "EG", "Y" )) %>% #this drops 153,813 rows and 95 permit/outfalls
#  filter(Parameter %in% c('00056 - Flow rate', '74076 - Flow', '00058 - Flow rate','82220 - Flow, total' ,
#     '50050 - Flow, in conduit or thru treatment plant' ,
#     '51061 - Flow (dry weather)' ))
# 
#  hist(dup_flow3$n)
# write.csv(dup_flow3, 'flow_duplicates.csv', row.names = F)
# ```

