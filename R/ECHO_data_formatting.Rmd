---
title: "format ECHO data"
author: "Alex Huddell"
date: "7/28/2021"
output:
  word_document: default
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries and data

```{r }
library(tidyverse)
library(lubridate)
library(here)

col_specifications<-('ffffffcdfff') #compact string to specify column types

dat<-read_csv(file=here("data","LIS_watershed_ECHO_effluent.csv"), 
                     col_types = col_specifications)

          
```


#Standardize data

```{r pressure, echo=FALSE}
levels(dat$Parameter)
levels(dat$Units)
dat$day<-day(dat$date)

dim(dat)

# add a key and number of days in month column, then filter out some problematic units
dat <- dat %>%
  mutate(days_per_month = days_in_month(date)) %>%
  mutate(day = day(date)) %>%
  filter(!Units == "(55) - Pounds") %>%
  filter(!Units == "(25) - Milliliters per Liter") %>%# omitting the few observations of these unclear units
  distinct() #removing duplicated values

dim(dat)

```

In the next chunk, we reduce the number of units to three--one for flow, one for 
concentration, and another for loading rate. 
```{r}
#standardize units to kg per month, million L per month, or milligram per liter
dat <- dat %>% mutate(
  kg_per_month =
    case_when(
      Units == "(26) - Pounds per Day" ~ value / 2.205 * days_per_month,
      Units == "(01) - Kilograms per Day" ~ value * days_per_month, # converts per day to per month
      Units == "(35) - Grams per Day" ~ value * 1000 * days_per_month, # converts g to kg and per day to per month
      Units == "(2R) - Pounds per Hour" ~ value / 2.205 * 24 * days_per_month, # converts pounds to kg and hours to months
      Units == "(9T) - Million Pounds per Day" ~ value * 10^6 / 2.205 * days_per_month, # converts millions of pounds to kg per month
    )
)

dat <- dat %>% mutate(
  million_L_per_month =
    case_when(
      Units == "(07) - Gallons per Day" ~ value / 10 ^ 6 * 3.785 * days_per_month,
      #converts from Gallons per day to millions L per month
      Units == "(08) - Cubic Feet per Second" ~ value * 28.317 / 10 ^ 6 * 60 * 60 * 24 * days_per_month,
      # converts cubic feet per second to million L per month
      Units == "(80) - Million Gallons per Month" ~ value * 3.785,
      # converts gallons to L
      Units == "(1X) - Gallons per Hour" ~ value / 10 ^ 6 * 3.785 * 24 * days_per_month,
      # converts gallons per hour to millions of L per month
      Units == "(8D) - Gallons per Month" ~ value / 10 ^ 6 * 3.785,
      # converts gallons to millions of L
      Units == "(03) - Million Gallons per Day" ~ value * 3.785 * days_per_month,
      # converts gallons to L and day to month
      Units == "(78) - Gallons per Minute" ~ value / 10 ^ 6 * 3.785 * 60 * 24 * days_per_month,
      # converts gallons to millions of L and minute to month
    )
)
  
dat <- dat %>% mutate(
  mg_per_L=
    case_when(
   Units == "(19) - Milligrams per Liter" ~ value,
   Units == "(28) - Micrograms per Liter" ~ value / 1000, #convert from micrograms to milligram
    )
  )
```
Next, we reduce the number of nitrogen to the following: total nitrogen "TN",
organic nitrogen "ON", ammonia "NH3", nitrite "NO2", nitrate "NO3", and inorganic N "IN".
We reduce the flow parameters to the following: flow rate 'flow_rate", 
maximum flow rate "flow_max_24h", total flow "flow_total", and dry flow "flow_dry".

```{r}
#cleaning up duplicate nitrogen and flow parameters 
dat$param_simple <- recode(dat$Parameter,
    #Nitrogen parameters
    "00600 - Nitrogen, total (as N)" = "TN",
    "00605 - Nitrogen, organic total (as N)" = "ON",
    "00610 - Nitrogen, ammonia total (as N)" = "NH3",
    "00615 - Nitrogen, nitrite total (as N)" = "NO2",
    "00620 - Nitrogen, nitrate total (as N)" = "NO3",
    "00625 - Nitrogen, Kjeldahl, total (as N)" = "TN",
    "51445 - Nitrogen, Total" = "TN",
    "00608 - Nitrogen, ammonia dissolved" = "NH3",
    "00630 - Nitrite + Nitrate total (as N)" = "IN",
    "00609 - Ammonia nitrogen, total, (as N) 30 day" = "NH3",
    "49579 - Nitrogen, total Kjeldahl" = "TN",
    "51447 - Nitrogen, Nitrite  Total" = "NO2",
    "51448 - Nitrogen, Nitrate  Total" = "TN",
    "51449 - Nitrogen, Kjeldahl  Total" = "TN",
    "51446 - Nitrogen, Ammonia  Total" = "NH3",
    "51087 - Nitrogen, Kjeldahl, total (TKN) (water)" = "TN",
    "51489 - Nitrogen, Total as NO3 + NH3" = "IN",
    "34726 - Nitrogen, ammonia, total (as NH3)" = "NH3",
    "51085 - Nitrogen, ammonia (NH3-N)" = "NH3",
    "51425 - Nitrogen, Total As N" = "TN",
    "51450 - Nitrite Plus Nitrate Total" = "IN", 
    #flow parameters
    "00056 - Flow rate" = "flow_rate",
    "50047 - Flow, maximum during 24 hr period" = "flow_max_24h",
    "74076 - Flow" = "flow_rate",
    "00058 - Flow rate" = "flow_rate",
    "50050 - Flow, in conduit or thru treatment plant" = "flow_rate", #questionable
    "82220 - Flow, total" = "flow_total",
    "00059 - Flow rate, instantaneous" = "flow_rate", #questionable
    "51061 - Flow (dry weather)" = "flow_dry"
  )

levels(dat$param_simple)

```

#Standardizing statistics codes
We have to make some decisions about standardizing the statistical codes. For now,
I excluded two stats that had conflicting information in different columns and 
were unclear. Then for now, I assigned simple "mean", "max", "min", and "total" 
since the data are reported on a monthly basis, even though there are sometimes
stats that differ--such as "daily" or "weekly" summary statistics. The next step 
will be to look at duplicate cases and determine a prioritization of certain
statistics over others in case of duplication within the same permit, month 
reported, and outfall.

```{r}

dat <- dat %>% filter(!`Statistical Base Long Desc` %in% c(
  "1 Day Average",
  "Maximum Hourly Rate"
)) # removing some rows with unclear metrics

dat$stat <- recode(dat$`Statistical Base Long Desc`,
    "Monthly Avg." = "mean",
    "Average Value" = "mean",
    "Rolling Average" = "mean",
    "30 Day Average" = "mean",
    "Average" = "mean",
    "30 Day Arithmetic Mean" = "mean",
    "30 Day Arithmetic" = "mean",
    "Daily Average"= "mean",
    "Instantaneous Maximum"="max",
    "Weekly Avg."="mean",
    "Weekly Maximum"="max",
    "Maximum"="max",
    "Daily Min."="min",
    "Daily Max."="max",
    "Maximum (Data Migration)"="max",
    "Average (Data Migration)"="mean",
    "30 Day Average"="mean",
    "Average"="mean",
    "Semi-Annual Average"="mean",
    "Quarterly Average"="mean",
    "Quarterly Maximum"="max",
    "Monthly Maximum"="max",
    "Monthly Geometric"="mean",
    "Discharged"="max",
    "Instantaneous Minimum"="min",
    "Annual Average"="mean",
    "Monthly Average Minimum"="min",
    "Annual Maximum"="max",
    "12 Month Average"="mean",
    "Monthly Total"="total",
    "Indiv 12 Mo Rolling Ave"="mean",
    "30 Day Arithmetic Mean"="mean",
    "30 Day Arithmetic"="mean",
    )

dat$stat <- droplevels(dat)$stat # dropping unused levels from dat$stat

levels(dat$stat)


```

This is an example of the duplicate values that are complicate reshaping the data from long to wide formatting. In this case, for key: CT0000086_1_1998-04-30.

```{r, echo=T}
#need to look into duplicates where there are multiple values for different stat columns
#testing it out on test case to demonstrate issues with pivoting
dat<- filter(dat, stat == "mean") #beginning with only mean summary statistics

test_case<-dat%>%  filter(key == "CT0000086_1_1998-04-30") %>%   distinct()

test <- 
  dat %>%
  filter(key == "CT0000086_1_1998-04-30")%>%
  filter(stat=="mean")%>%
  select(key, permit, Outfall, date,param_simple, stat, days_per_month,
         mg_per_L, million_L_per_month, kg_per_month) %>%
  distinct()


test


```

Here we pivot the data wider and summarize duplicates by min, mean, and max.

```{r}
#function to id columns with all NAs
not_all_na <- function(x) any(!is.na(x))

#pivot wider and then remove columns with only NAs (since some parameter/unit combinations 
#don't make sense)
max_vals<-dat %>%
  pivot_wider(names_from = c(stat, param_simple), 
              values_from =c(mg_per_L, million_L_per_month,kg_per_month),
              values_fn = max) %>%
  select_if(not_all_na)

mean_vals<-dat %>%
  pivot_wider(names_from = c(stat, param_simple), 
              values_from =c(mg_per_L, million_L_per_month,kg_per_month),
              values_fn = mean)%>%
  select_if(not_all_na)

min_vals<-dat %>%
  pivot_wider(names_from = c(stat, param_simple), 
              values_from =c(mg_per_L, million_L_per_month,kg_per_month),
              values_fn = max)%>%
  select_if(not_all_na)


max_vals
min_vals
mean_vals

write.csv(max_vals, file=here("data", "ECHO_data_summarized_maximum_values.csv"),row.names = F)
write.csv(min_vals, file=here("data", "ECHO_data_summarized_minimum_values.csv"), row.names = F)
write.csv(mean_vals, file=here("data","ECHO_data_summarized_mean_values.csv"), row.names = F)


```



