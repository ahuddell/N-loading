---
title: 'format PCS data'
author: 'Alex Huddell'
date: '10/7/2021'
output:
  word_document: default
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries and data

```{r load libs}
library(tidyverse)
library(lubridate)
library(here)

dat<-read_csv(file=here('data','PCS_LIS_watershed_data.csv'))

# #read in CT data from N exchange program
# CT<-read_csv(file=here("data","CT_NX_data.csv"))
# CT<-distinct(CT) #remove a few duplicate rows
# CT_permits<-unique(CT$permit)


#join by location and SIC code to filter out SIC codes other than sewarage systems, fish hatcheries, and paper mills 
outfall_locations <-
  read_csv(file = here("data", "npdes_outfalls_layer.csv"))
names(outfall_locations)
names(dat)
outfall_locations<-rename(outfall_locations,"Permit Num (NPID)"=EXTERNAL_PERMIT_NMBR)

join<-left_join(dat,outfall_locations)

# SIC_desc<-join %>% group_by(SIC_CODES, SIC_DESCRIPTIONS) %>%
#   summarize(first(SIC_CODES))
# write.csv(SIC_desc, "SIC codes PCS.csv", row.names = F)
          
```


#Create key for each outfall/date and check how many rows per key.

```{r create key, echo=FALSE}
dat$date<-ymd(dat$`Monitoring Dt (MVDT)`)

dat <- dat %>%
  mutate(days_per_month = days_in_month(date)) %>%
  mutate(key = paste0(`Permit Num (NPID)`,`Discharge Num (DSCH)`,date))

nrow(dat) #there are 196,586 rows
dat %>% count(key) #there are 95,366 unique keys, so some keys have duplicate rows

#plot the frequency of different parameters
dat$param<-as.factor(dat$'Parameter Cd (PRAM)')
levels(dat$param)

levels<-dat %>%
  group_by(param) %>%
  tally()

ggplot(levels, aes(param,n))+
  geom_col() +
  ylab('count of observations')+
  theme(axis.text.x=element_text(angle = 30, hjust=1))

```

```{r rename, organize, and filter}

#renaming columns  
dat<-dat%>%
  rename(facility=`Facility Name Short (FNMS)`,
         permit=`Permit Num (NPID)`,
         Outfall=`Discharge Num (DSCH)`,
         quant_avg=`Meas Quant Avge (MQAV)`,
         conc_avg=`Meas Conc Avge (MCAV)`) %>%
# reformatting date and add a key and number of days in month column, then filter out some problematic units
  mutate(key = paste0(permit, '_', Outfall, '_', date)) %>%
  mutate(days_per_month = as.numeric(days_in_month(date))) %>%
  mutate(permit_outfall = as.factor(paste0(permit, "_", Outfall))) %>%
  mutate(permit_outfall_designator=as.factor(paste0(permit,"_",Outfall,"_",`Discharge Designator (DRID)`))) %>%
  mutate(state=substr(permit,1,2)) #add column with state abbreviation 


##read outfall locations data, add key, and join to dat so we can filter by SIC code
outfall_locations <-
  read_csv(file = here("data", "npdes_outfalls_layer.csv"))

outfall_locations$permit<-outfall_locations$EXTERNAL_PERMIT_NMBR

join<-left_join(dat,outfall_locations, by='permit')

SIC_permit<-join %>%
  group_by(permit) %>%
  summarize(SIC=first(SIC_DESCRIPTIONS),
            SIC_CODES=first(SIC_CODES))

SIC_permit_count<-SIC_permit %>%
  group_by(SIC,SIC_CODES) %>%
  tally()%>%
  arrange(desc(n))

SIC_permit_count %>%
  filter(n>5)%>%
  ggplot(aes(SIC ,n))+
  geom_col() +
  ylab("count of observations")+
  theme(axis.text.x=element_text(angle = 60, hjust=1))


#list of SIC codes to keep?
#	Sewerage Systems--4952
# Colleges And Universities; Elementary And Secondary Schools--8221
#Services; Sewerage Systems--8999 
#Fish Hatcheries And Preserves--921
#Paper Mills--2621
SIC_CODES_keep<-c('4952','8221','8999', '921', '2621', '4952 8221', '9512 4952',
                  '8999 4952')

permits_to_keep<-join %>%
  filter(SIC_CODES %in% SIC_CODES_keep) %>%
  group_by(permit)%>%
  summarize(permit=first(permit),
            facility=first(facility))

#filtering out unwanted observations
dat<- dat %>% 
  filter(permit %in% (permits_to_keep$permit)) %>%  
  filter(!permit %in% c('CT0000434','CT0026476','NY0065340','NY0066028')) %>% #removing some industrial permits that seem unrelated to sewerage systems, but some small private WWTPs are still included (like hospitals)
  #removing unwanted discharge codes and monitoring locations
  filter(`Monitoring Location (MLOC)` %in% c("1", "2", "EA", "EG", "Y")) %>%
  #removing one unclear unit that only relates to a few observations of flow maxima
  filter(!`Quant Unit Cd Desc (LQUCD)` =='(3R) - Million Gallons')%>%
  #omitting this parameter because we don't know what it means, but most
  filter(!param=='50047 - Flow, Maximum During 24 Hr Period') %>%
  filter(!param=='00059 - Flow Rate, Instantaneous') %>%
  filter(!param=='51061 - Flow (dry weather)')# %>% #there are only a few observations of this and none had data we could use
  # filter(!permit %in% CT_permits) #this line removes the CT waste water treatment plants because we will use CTDEEP data for those
  # 
  # #add in all of the specific cases we need to omit to eliminate duplicates
  # filter(!permit_outfall_designator == 'CT0003824_001_A')  %>%  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month
  # filter(!permit_outfall_designator == 'CT0003824_001_B')  %>%  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month
  # filter(!permit_outfall_designator == 'CT0003824_001_D')  %>%  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month
  # filter(!permit_outfall_designator == 'CT0003824_001_E')  %>%  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month
  # filter(!permit_outfall_designator == 'CT0003824_002_A')  %>%  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month
  # filter(!permit_outfall_designator == 'CT0003824_002_C')  #this one I'm not sure, but for ECHO data we chose C; here it seems the measurements vary across designators more from month to month

dat$`Quant Unit Cd Desc (LQUCD)` <- droplevels(dat)$`Quant Unit Cd Desc (LQUCD)` # dropping unused levels from dat$`Quant Unit Cd Desc (LQUCD)`
dat$`Conc Unit Cd Desc (LCUCD)` <- droplevels(dat)$`Conc Unit Cd Desc (LCUCD)` # dropping unused levels from dat$`Quant Unit Cd Desc (LQUCD)`
dat$param<- droplevels(dat)$param # dropping unused levels from dat$param

#make values numeric
dat$quant_avg<-as.numeric(dat$quant_avg)
dat$conc_avg<-as.numeric(dat$conc_avg)


dim(dat)

length(unique(as.character(dat$permit_outfall))) #261 permit/outfalls
length(levels(as.factor(dat$key))) #38,142 keys
```


In the next chunk, we reduce the number of units to three--one for flow, one for 
concentration, and another for loading rate. 

```{r standardize units}
#standardize units to kg per month, million L per month, or milligram per liter
dat <- dat %>% mutate(
  kg_per_month =
    case_when(
      `Quant Unit Cd Desc (LQUCD)` == '(26) - Pounds per Day' ~ quant_avg / 2.205 * days_per_month,
      `Quant Unit Cd Desc (LQUCD)` == '(01) - Kilograms per Day' ~ quant_avg  * days_per_month # converts per day to per month
             )
)

#standardize units to millions of L per month
dat <- dat %>% mutate(
  million_L_per_month =
    case_when(
      `Quant Unit Cd Desc (LQUCD)` == '(07) - Gallons per Day' ~ quant_avg / 10 ^ 6 * 3.785 * days_per_month,
      #converts from Gallons per day to millions L per month
      `Quant Unit Cd Desc (LQUCD)` == '(08) - Cubic Feet per Second' ~ quant_avg * 28.317 / 10 ^ 6 * 60 * 60 * 24 * days_per_month,
      # converts cubic feet per second to million L per month
      
      `Quant Unit Cd Desc (LQUCD)` == '(8D) - Gallons per Month' ~ quant_avg / 10 ^ 6 * 3.785,
      # converts gallons to millions of L
      `Quant Unit Cd Desc (LQUCD)` == '(03) - Million Gallons per Day' ~ quant_avg  * 3.785 * days_per_month,
      # converts gallons to L and day to month
      `Quant Unit Cd Desc (LQUCD)` == '(78) - Gallons per Minute' ~ quant_avg  / 10 ^ 6 * 3.785 * 60 * 24 * days_per_month,
      # converts gallons to millions of L and minute to month
    )
)

#converting all N parameters to mass terms of nitrogen and not others (i.e. ammonia, nitrite, etc.)


dat$conc_avg <-  ifelse(
  dat$param == '00608 - Nitrogen, ammonia dissolved',
  dat$conc_avg * 14.0067 / 17.031,
  dat$conc_avg
)

dat$conc_avg <- ifelse(
  dat$param == '34726 - Nitrogen, ammonia, total (as NH3)',
  dat$conc_avg * 14.0067 / 17.031,
  dat$conc_avg
)

dat$conc_avg <- ifelse(
  dat$param ==  '71850 - Nitrogen, Nitrate Total (As No3)' ,
  dat$conc_avg * 14.0067 / 62.0049,
  dat$conc_avg
)

   
#standardize concentrations to milligrams N per liter  
dat <- dat %>% mutate(
  mg_N_per_L=
    case_when(
   `Conc Unit Cd Desc (LCUCD)` == 'Milligrams Per Liter' ~ conc_avg,
   `Conc Unit Cd Desc (LCUCD)` == 'Micrograms Per Liter' ~ conc_avg / 1000, #convert from micrograms to milligram
    )
  )



```
Next, we reduce the number of nitrogen to the following: total nitrogen 'TN',
organic nitrogen 'ON', ammonia 'NH3', nitrite 'NO2', nitrate 'NO3', and inorganic N 'IN'.
We reduce the flow parameters to the following: flow rate 'flow_rate', 
maximum flow rate 'flow_max_24h', total flow 'flow_total', and dry flow 'flow_dry'.

```{r simplify parameters}
#cleaning up duplicate nitrogen and flow parameters 
dat$param<-as.factor(dat$param)

         
#dat<-dat %>% mutate(param_simple=recode(dat$param,
#cleaning up duplicate nitrogen and flow parameters 
dat$param_simple <- recode(dat$param,

    # #Nitrogen parameters
    '00600 - Nitrogen, Total (As N)' = 'TN',
    '00605 - Nitrogen, Organic Total (As N)' = 'ON',
    '00608 - Nitrogen, Ammonia Dissolved' = 'NH3',
    '00610 - Nitrogen, Ammonia Total (As N)' = 'NH3',
    '00615 - Nitrogen, Nitrite Total (As N)' = 'NO2',
    '00620 - Nitrogen, Nitrate Total (As N)' = 'NO3',
    '00625 - Nitrogen, Kjeldahl, Total (As N)'='TKN',
    '00630 - Nitrite Plus Nitrate Total 1 Det. (As N)' = 'NO2NO3',
    '34726 - Nitrogen, Ammonia, Total (As Nh3)' = 'NH3',
    '49579 - Nitrogen, Total Kjeldahl' = 'TKN',
    '51087 - Nitrogen, Kjeldahl, Total (Tkn) (Water)' = 'TKN',
    '71850 - Nitrogen, Nitrate Total (As No3)' ='NO3',
    #flow parameters
    '50050 - Flow, In Conduit Or Thru Treatment Plant' ='flow_rate',
    '51061 - Flow (Dry Weather)' = 'flow_rate',
    '00056 - Flow Rate' = 'flow_rate',
    '74076 - Flow' = 'flow_rate',
    '00058 - Flow Rate' = 'flow_rate',
    '82220 - Flow, Total' = 'flow_total',

    
  )

#analyzing distribution of parameters
levels(dat$param_simple)

levels<-dat %>%
  group_by(param_simple) %>%
  tally()

ggplot(levels, aes(param_simple,n))+
  geom_col() +
  ylab('count of observations')


levels(dat$param)

levels<-dat %>%
  group_by(param) %>%
  tally()

ggplot(levels, aes(param,n))+
  geom_col() +
  ylab('count of observations')+
  theme(axis.text.x=element_text(angle = 60, hjust=1))


```

Let's separate the keys for which kg N/month loads already exist from those which don't.

```{r separate observations reporting loads}
#review duplicates
dat %>%
  filter(!is.na(kg_per_month)) %>%
  filter(param_simple=='TN') %>%
  group_by(key)%>%
  tally() %>%
  arrange(desc(n))
#there are no duplicates

#subset of data that report loads
N_load<- dat %>%
  group_by(key) %>%
  filter(!is.na(kg_per_month)) %>%
    #removing unwanted columns
  select(
    !c('Monitoring Dt (MVDT)',
        'Discharge Designator (DRID)', 
       'Parameter Cd (PRAM)',
       'Monitoring Location (MLOC)',
       '#MULTIVALUE',   
       'Meas Quant Maxm (MQMX)', 
       'Quant Unit Cd (LQUC)',
       'Quant Unit Cd Desc (LQUCD)',
       'Meas Conc Minm (MCMN)',
       #'Meas Conc Maxm (MCMX)...15',
       #'Meas Conc Maxm (MCMX)...16',
       'Conc Unit Cd (LCUC)',
       'Conc Unit Cd Desc (LCUCD)' )
  ) %>%
  distinct() #removing any duplicate rows


#check if there are duplicates per key and one parameter
N_load %>%
  group_by(key)%>%
  filter(param_simple=='TN') %>%
  tally() %>%
  arrange(desc(n))
# there are no duplicates

#pivoting the TN and NH3 observations into wide format and removing flow and concentration columns
N_load_a<-N_load %>%
   pivot_wider(names_from = param_simple,
              values_from = kg_per_month) %>%
   select(-million_L_per_month,- mg_N_per_L ,- NO3, - NO2, -TKN, -NO2NO3, -`Meas Conc Maxm (MCMX)...16`, -`Meas Conc Maxm (MCMX)...15`) %>%
  rename(kg_N_TN_per_month=TN,
         kg_N_NH3_per_month=NH3)

names(N_load_a)
length(unique(as.character(N_load_a$permit_outfall))) #38 outfalls included here 
```

Here we pivot the data wider calculate loads based on the concentrations and flow data, and remove the concentration and flow columns after we use them.


```{r calculating loads for other observations}
#function to id columns with all NAs
not_all_na <- function(x) any(!is.na(x))

#review duplicates
keys_with_N<- dat %>%
  group_by(key) %>%
  filter(!any(!is.na(kg_per_month)))%>% #this removes any keys which do report in N loads
  filter(any(as.character(param) %in% c(
      '00625 - Nitrogen, Kjeldahl, Total (As N)',
      '00605 - Nitrogen, Organic Total (As N)',
      '00610 - Nitrogen, Ammonia Total (As N)',
      '00615 - Nitrogen, Nitrite Total (As N)',
      '00620 - Nitrogen, Nitrate Total (As N)',
      '71850 - Nitrogen, Nitrate Total (As No3)',
      '00600 - Nitrogen, Total (As N)',
      '34726 - Nitrogen, Ammonia, Total (As Nh3)',
      '00630 - Nitrite Plus Nitrate Total 1 Det. (As N)',
      '00608 - Nitrogen, Ammonia Dissolved',
      '51087 - Nitrogen, Kjeldahl, Total (Tkn) (Water)',
      '49579 - Nitrogen, Total Kjeldahl'
    ))) #this removes any keys which do report any other N parameters

keys_with_N


dup<-keys_with_N %>%
  filter(param_simple == 'flow_rate') %>%
  group_by(key, param_simple)%>%
  tally() %>%
  arrange(desc(n))
dup #there are lots of flow rate duplicates from multiple parameters reported for the same date, but we will select flow parameters-- 50050 first, then 00056, then 74076, then 0058

dup<-keys_with_N %>%
  group_by(key) %>%
  filter(!param_simple == 'flow_rate') %>%
  drop_na(mg_N_per_L)%>%
  group_by(key, param_simple)%>%
  tally() %>%
  filter(n>1)%>%
    arrange(desc(n))
dup #there is just one permit/outfall/date with N parameters duplicates that we can remove

# here we separate different flow parameters to remove duplicates observations

#this filters the groups of rows at the grouped (key) level that do include the 50050  parameter
flow_50 <- keys_with_N %>%
  #  group_by(key) %>%
  # filter(!any(!is.na(kg_per_month)))%>% #this removes any keys which do report in N loads
  # # filter(is.na(kg_per_month)) %>%
  group_by(key) %>%
  filter(any(param == '50050 - Flow, In Conduit Or Thru Treatment Plant')) %>% #this filters a group of rows at the grouped (key) level, and selects first this most common param
  filter(param == '50050 - Flow, In Conduit Or Thru Treatment Plant')

#next, this filters the groups of rows at the grouped (key) level that do not include the 50050 param, and selects 00056
flow_56 <-keys_with_N %>%
  # group_by(key) %>%
  # filter(!any(!is.na(kg_per_month)))%>% #this removes any keys which do report in N loads
  # # filter(is.na(kg_per_month)) %>%
  group_by(key) %>%
  filter(!any(param == '50050 - Flow, In Conduit Or Thru Treatment Plant')) %>%
  filter(param == '00056 - Flow Rate')

#finally, we collect all nitrogen related parameters to bind to the flow observations
N_params<- keys_with_N %>%
group_by(key) %>%
  filter(!any(!is.na(kg_per_month)))%>% #this removes any keys which do report in N loads
    # filter(is.na(kg_per_month)) %>%
  filter(!param == '50050 - Flow, In Conduit Or Thru Treatment Plant') %>%
  filter(!param == '00056 - Flow Rate') %>%
  filter(!param == '74076 - Flow') %>%
  filter(!param == '00058 - Flow rate') %>%
  filter(!param == '51061 - Flow (dry weather)') %>%
  filter(! key=='CT0100081_1_1989-12-31') %>% #remove one problematic set of duplicate observation
   drop_na(mg_N_per_L)%>%
distinct() 

#bind all observations back together
flow_cleaned<-rbind(flow_50,flow_56,N_params) 

#review duplicates
dups2<-flow_cleaned %>%
  group_by(key, param_simple)%>%
  tally() %>%
  arrange(desc(n))
dups2 #there are no more duplicates


flow_cleaned <- flow_cleaned %>%
#removing unwanted columns
  select(
    !c('Monitoring Dt (MVDT)',
        'Discharge Designator (DRID)',
       'Parameter Cd (PRAM)',
       'Monitoring Location (MLOC)',
       '#MULTIVALUE',
       'Meas Quant Maxm (MQMX)',
       'Quant Unit Cd (LQUC)',
       'Quant Unit Cd Desc (LQUCD)',
       'Meas Conc Minm (MCMN)',
       'Meas Conc Maxm (MCMX)...15',
       'Meas Conc Maxm (MCMX)...16',
       'Conc Unit Cd (LCUC)',
       'Conc Unit Cd Desc (LCUCD)' )
  )

#subset of data that DO NOT report loads, then
#pivot wider and then remove columns with only NAs (since some parameter/unit combinations that don't make sense)

flow_N_concentration <- flow_cleaned %>%
  group_by(key) %>%
  #filter(any(is.na(kg_per_month))) %>%
   pivot_wider(names_from = param_simple,
              values_from = c(mg_N_per_L, million_L_per_month)) %>%
  select_if(not_all_na)

#calculating N loads
N_load_b <- flow_N_concentration %>%
  mutate(kg_N_TN_per_month = mg_N_per_L_TN * million_L_per_month_flow_rate) %>%
  mutate(kg_N_ON_per_month = mg_N_per_L_ON * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NH3_per_month = mg_N_per_L_NH3 * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NO2_per_month = mg_N_per_L_NO2 * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NO3_per_month = mg_N_per_L_NO3 * million_L_per_month_flow_rate) %>%
   mutate(kg_N_TKN_per_month = mg_N_per_L_TKN * million_L_per_month_flow_rate) %>%
  mutate(kg_N_NO3NO2_per_month = mg_N_per_L_NO2NO3 * million_L_per_month_flow_rate) %>%
  select(
    -mg_N_per_L_TN,
    -mg_N_per_L_NH3,
    -mg_N_per_L_NO2,
    -mg_N_per_L_NO3,
    -mg_N_per_L_NO2NO3,
    -mg_N_per_L_TKN,
    -mg_N_per_L_ON,
    -million_L_per_month_flow_rate,
  )

#combine N columns in N_load_b to standardize and join dataframes
names(N_load_b)

#check if any rows contain both NO3 or NO2 and NO3NO2 before we combine them
filter(N_load_b, !is.na(kg_N_NO3_per_month) & !is.na(kg_N_NO3NO2_per_month))
filter(N_load_b, !is.na(kg_N_NO2_per_month) & !is.na(kg_N_NO3NO2_per_month))
#there are none, so we can add them without double counting

N_load_b$kg_N_sum_per_month <-
  ifelse(!is.na(N_load_b$kg_N_TKN_per_month),
    ( N_load_b$kg_N_TKN_per_month + N_load_b$kg_N_NO3_per_month + N_load_b$kg_N_NO2_per_month + N_load_b$kg_N_NO3NO2_per_month) ,
    ( N_load_b$kg_N_NH3_per_month + N_load_b$kg_N_NO3_per_month + N_load_b$kg_N_NO2_per_month + N_load_b$kg_N_NO3NO2_per_month +        N_load_b$kg_N_ON_per_month))

#remove intermediate columns we no longer need
N_load_b <- N_load_b %>%
  select(
    -kg_N_NH3_per_month,-kg_N_NO3_per_month,
    -kg_N_NO2_per_month,
    -kg_N_ON_per_month,
    -kg_N_NO3NO2_per_month,
    -kg_N_ON_per_month,
    -kg_N_TKN_per_month
  )

#combine the different N columns; use total N when reported, or the sum of all other
#forms of N if TN is not reported
N_load_b$kg_N_TN_per_month <-
  ifelse(!is.na(N_load_b$kg_N_TN_per_month),
    N_load_b$kg_N_TN_per_month,
    N_load_b$kg_N_sum_per_month )

#remove N sum column
N_load_b<- N_load_b %>%
  select(-kg_N_sum_per_month, -permit_outfall_designator)

names(N_load_b)
length(unique(as.character(N_load_b$permit_outfall))) #203 outfalls included here

#for N_load_a
#combine the different N columns; use total N when reported, or the sum of all other
#forms of N if TN is not reported

#here we split the grouped keys apart and then put them back together to select only one kg_N_TN_per_month per key
N_load_a_1 <-N_load_a%>%
  group_by(key) %>%
  filter(all(is.na(kg_N_TN_per_month)))%>% #filter to groups with no reported kg_N_TN_per_month value
  mutate(kg_N_TN_per_month=kg_N_NH3_per_month)%>% #and use the reported NH3 value instead
  select(-kg_N_NH3_per_month)

N_load_a_2 <-N_load_a%>%
  group_by(key) %>%
  filter(any(!is.na(kg_N_TN_per_month)))%>% #filter to groups with at least one reported kg_N_TN_per_month value to bind to the rest of the data
  select(-kg_N_NH3_per_month)
  
N_load_a<-rbind(N_load_a_1,N_load_a_2) #bind the two groups back together
  
names(N_load_a)

#combine dataframes
N_load<-rbind(N_load_a,N_load_b)
N_load<-drop_na(N_load,kg_N_TN_per_month) #dropping NA values 

length(unique(as.character(N_load$permit_outfall))) #35 outfalls with/without locations
length(unique(as.character(N_load$key))) #3,115 keys

summary(N_load$kg_N_TN_per_month)

```


Loading in NPDES database with NPDES ID to match locations and other data.

```{r outfall location join}
outfall_locations <-
  read_csv(file = here("data", "npdes_outfalls_layer.csv"))

names(outfall_locations)

outfall_locations<-outfall_locations %>%
  select(EXTERNAL_PERMIT_NMBR,
         FACILITY_NAME,
         SIC_CODES,
         SIC_DESCRIPTIONS,
         PERM_FEATURE_NMBR,
         STATE_WATER_BODY_NAME,
         LATITUDE83,
         LONGITUDE83)


outfall_locations$permit_outfall <-
  paste0(outfall_locations$EXTERNAL_PERMIT_NMBR,
         "_",
         outfall_locations$PERM_FEATURE_NMBR)

#join locations based on permit number and outfall number
dim(N_load) #3173
length(unique(N_load$permit_outfall)) #35 outfalls with/without locations
length(unique(N_load$key)) #3115 keys

N_load_out <- left_join(N_load, outfall_locations, by = "permit_outfall")
dim(N_load_out) #3173, 20

length(unique(as.character(N_load_out$permit_outfall))) #35 outfalls with locations
length(unique(as.character(N_load_out$key))) #3115 keys
#same data after join

#check for NA's in latitude
summary(N_load_out$LATITUDE83) #268 missing values
missing_latitude<-N_load_out %>% filter(is.na(LATITUDE83)) %>%
  group_by(permit_outfall)%>%
  summarize(LATITUDE83=first(LATITUDE83))

```

Loading in NPDES database with NPDES ID to match locations and other data.


```{r}
#HUC8 outfall join
HUC8_outfall_locations <-
  read_csv(file = here('data', 'huc8_outfall_join.csv'))

#select columns
HUC8_outfall_locations <- HUC8_outfall_locations %>%
  select('EXTERNAL_PERMIT_NMBR',
         'PERM_FEATURE_NMBR',
         'huc8',
         'name')

names(HUC8_outfall_locations)

# #need to remove leading zeroes from outfall column
# HUC8_outfall_locations$PERM_FEATURE_NMBR <- sub("^0+", "", HUC8_outfall_locations$PERM_FEATURE_NMBR)
# HUC8_outfall_locations$PERM_FEATURE_NMBR
# 

#create key variables with permit and locations for join
HUC8_outfall_locations$permit_outfall <-
  paste0(HUC8_outfall_locations$EXTERNAL_PERMIT_NMBR,
         "_",
         HUC8_outfall_locations$PERM_FEATURE_NMBR)


#join locations based on permit number and outfall number
dat_join<- left_join(N_load_out, HUC8_outfall_locations, by = "permit_outfall")

dim(N_load_out) #3173
dim(dat_join) #3173
length(unique(as.character(dat_join$permit_outfall))) #35 outfalls with locations
length(unique(as.character(dat_join$key))) #3115 keys

#the number of keys and outfalls with locations are the same as in the last step

#check for NA's in huc8s
missing_huc8<-dat_join %>% filter(is.na(huc8)) %>%
  group_by(permit_outfall)%>%
  summarize(huc8=first(huc8),
            LATITUDE83=first(LATITUDE83),
            LONGITUDE83=first(LONGITUDE83))
missing_huc8

#there are 5 outfalls with missing HUC8 assignments
write_csv(missing_huc8,
          file = here("PCS_missing_huc8.csv"))

write.csv(dat_join,
          file = here("data", "PCS_data_clean.csv"),
          row.names = F)


```
